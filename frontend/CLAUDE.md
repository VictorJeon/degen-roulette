# Project: frontend

## Learned patterns

- [2026-02-08] Playwright E2E — Use polling-based `waitForFunction` instead of event listeners for async initialization (more reliable with Next.js 16 Turbopack), add globalSetup to verify dev server readiness
- [2026-02-08] (Playwright + Next.js 16 Turbopack) JSON 파일 동적 import는 런타임 번들링 실패 가능 → TypeScript 파일로 변환하여 해결
- [2026-02-08] Database optional for E2E tests — Check `!process.env.POSTGRES_URL` and return early/empty data in API routes (leaderboard, errors) to allow tests without database
- [2026-02-08] Solana wallet adapter testing — TestWalletAdapter must be added synchronously to wallet list (detect `?testMode=true` during render, not in useEffect). Manual wallet selection via modal works better than autoConnect for test wallet stability
- [2026-02-08] TestWalletAdapter race condition fix — Load keypair synchronously in constructor (import test-keypair.json directly) instead of waiting for window.solana. Track _connected state separately from publicKey availability to match wallet-adapter expectations. AutoConnect requires both localStorage walletName AND wallet in Installed state before WalletProvider mounts.
- [2026-02-09] **wallet-adapter-react state management limitation** — Direct calls to `adapter.connect()` don't update `useWallet()` context state. The WalletProvider manages connection state independently through its own `select()` and `connect()` methods. For E2E tests, must use either: (1) `useWallet().select(walletName)` + `useWallet().connect()` exposed via window helper, or (2) Playwright click automation to select wallet from modal, or (3) Bypass UI checks and use window.solana directly. `WalletReadyState` is a string enum ("Installed"), not number.
- [2026-02-09] **wallet-adapter-react async state updates** — Even when calling `useWallet().select()` and `useWallet().connect()` via window helper, the `connected` and `publicKey` values in the closure remain stale. React state updates are asynchronous. E2E tests must poll for actual state changes by repeatedly calling a fresh `__walletStatus()` function rather than relying on the return value of `connect()`. The wallet button text and `useWallet().connected` only update after React re-renders.
- [2026-02-09] **Next.js tsconfig.json JSX setting** — Use `"jsx": "preserve"` instead of `"react-jsx"`. Next.js 16 handles JSX transformation internally with its own runtime. Using `"react-jsx"` can cause build issues with Turbopack.
- [2026-02-09] **Environment variables** — `.env.local` contains sensitive keys. Always create `.env.example` with placeholders and comments. Required vars: `VERCEL_OIDC_TOKEN` (Vercel CLI auth), `HOUSE_AUTHORITY_KEYPAIR` (Solana keypair as JSON array), `POSTGRES_URL` (PostgreSQL connection string for game state and leaderboard).
- [2026-02-09] **E2E testMode publicKey fallback (Phase 5)** — Created `lib/testMode.ts` helper with `getPublicKey()` function that falls back to `window.solana.publicKey` when `useWallet().publicKey` is null in testMode. Applied to `BetPanel.tsx`, `useGame.ts`, and `ErrorReporterInit.tsx`. This fixes UI checks (bet validation, wallet display) but doesn't solve transaction signing - `useAnchorWallet()` still returns null because wallet-adapter-react context doesn't update. Result: 8/13 E2E tests passing (smoke + error-handling). Game flow tests still fail at startGame() because transaction signing requires actual wallet adapter context, not just window.solana fallback.
- [2026-02-09] **E2E testMode AnchorWallet fallback (Phase 6)** — Extended `lib/testMode.ts` with `getAnchorWallet()` function that wraps `window.solana` as an AnchorWallet interface when `useAnchorWallet()` returns undefined in testMode. The wrapper provides `{ publicKey, signTransaction, signAllTransactions }` by delegating to `window.solana`. Applied to `hooks/useGame.ts`, `hooks/useProgram.ts`, and `hooks/useLeaderboard.ts` by wrapping `useAnchorWallet()` results. This should enable transaction signing in E2E tests, but verification blocked by missing POSTGRES_URL - game API routes (`/api/game/start`, `/api/game/active`) require database access and don't have optional fallback logic yet. Phase 5 pattern of checking `!process.env.POSTGRES_URL` not yet applied to game routes, only to leaderboard/errors routes.
- [2026-02-09] **E2E In-Memory Game Mock (Phase 7)** — Created `lib/game-mock.ts` providing in-memory Map-based game state management with same interface as DB (createGame, getGame, getActiveGame, updateGame, etc.). All game API routes (`/api/game/start`, `/api/game/active/[wallet]`, `/api/game/pull`, `/api/game/confirm`) now check `!process.env.POSTGRES_URL` and use mock instead of DB. This allows E2E tests to run without database dependency. Mock includes 5-minute active game window logic, pending game cleanup, and bullet position calculation matching production. Pattern: `if (!process.env.POSTGRES_URL) { /* use gameMock */ } else { /* use DB */ }`. Result: 8+ out of 13 E2E tests passing, all game flow tests can now reach gameplay without DB errors.
- [2026-02-09] **Mobile UI optimization** — On mobile (≤768px), remove `.game-card` borders/backgrounds for fullscreen feel: `background: transparent !important; border: none !important; box-shadow: none !important`. Hide corner pseudo-elements with `::before, ::after { display: none !important }`. Increase revolver size to `min(300px, 75vw)` on 768px, `min(260px, 70vw)` on 480px. Make multiplier table more compact: `padding: 6px 4px`, `gap: 3px`, smaller fonts. Add margin adjustments: `.game-main { gap: 0.5rem; padding-top: 0.5rem }`, `.multiplier-table { margin-bottom: 4px }`. Apply same styling in both `app/globals.css` and `components/GameBoard.tsx` media queries. Result: Revolver no longer looks "trapped in a box" on mobile, more breathing room, cleaner fullscreen aesthetic.
- [2026-02-09] **Solana RPC stability for mobile** — Mobile browsers can have unreliable network connections causing blockhash fetch failures. In `lib/anchor.ts`, configure Connection with `{ commitment: 'confirmed', confirmTransactionInitialTimeout: 60000, wsEndpoint: undefined }` (disabling WebSocket improves mobile stability). In `hooks/useGame.ts` startGame(), add retry logic for blockhash fetch: attempt up to 3 times with 1s delay between retries, throw user-friendly error "Network error: Could not connect to Solana" on final failure. Wrap catch block to detect `TypeError: Load failed` and convert to readable message. Pattern: `for (let i = 0; i < 3; i++) { try { blockhash = await connection.getLatestBlockhash(); break; } catch { if (i === 2) throw ...; await sleep(1000); } }`. Result: Prevents "Load failed" errors on poor mobile connections, gives users clear feedback instead of cryptic network exceptions.
- [2026-02-10] **Font Hierarchy (Mason 확정)** — Tier 1 Silkscreen(font-pixel): 타이틀 "DEGEN ROULETTE" + "YOU LIVE/DIED" 극소수만. Tier 2 Chakra Petch(font-display): CTA 버튼 + R1-R5 라벨 + 섹션 헤더. Tier 3 Space Mono(font-body): 나머지 전부. pixel 폰트를 라벨/헤더에 뿌리면 위계 무너짐.
- [2026-02-10] **UI Polish v2** — CONNECT WALLET(지갑 미연결 시), 확률 분수 제거, 실린더 dim(idle brightness-[0.35] saturate-[0.3]→active full), footer 링크 카드 밖 이동, 간격 gap-5, 모바일 max-w-[360px] px-5.
- [2026-02-10] **진행 상태** — `specs/ui-redesign-progress.md` 참고. 다음: baseline-ui → fixing-accessibility → 3-col layout.
- [2026-02-09] **Component Redesign v1 — CRT→Flat Migration** — Removed all `<style jsx>` blocks from 7 components (Header, StatsBar, LiveFeed, Leaderboard, BetPanel, ResultOverlay, GameBoard) and replaced with Tailwind v4 utility classes. Rewrote `globals.css` from 2233 lines to ~280 lines. New design tokens in `@theme`: `bg-primary=#080C08`, `bg-surface=#0E130E`, `bg-elevated=#151A15`, `accent=#00FF41`, `border-default=#252525`, `danger=#FF3B3B`, `font-display='Press Start 2P'`, `font-body='Space Grotesk'`. Deleted: grid overlays, scanlines, vignette, all neon glow/pulse keyframes, corner decorations, sparkle particles, CornerDecor component, `.btn-glow` spans. Kept: `screenShake`, `shake`, `spin`, `fadeIn` keyframes, `.flash-overlay`, wallet adapter overrides, input spinner removal. Only CTA glow remaining: `shadow-[0_0_20px_rgba(0,255,65,0.15)]` on start-game and play-again buttons. Mobile responsive via Tailwind `max-md:` / `max-sm:` / `max-[360px]:` prefixes. All 8 `data-testid` attributes preserved. `pnpm build` passes.
